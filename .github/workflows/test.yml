name: Swift Package Manager Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-15
    
    steps:
    - name: â¬‡ï¸ Checkout repository
      uses: actions/checkout@v4

    - name: âš™ï¸ Set Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.4.app

    - name: ğŸ“¦ Restore iOS Runtime DMG Cache
      id: cache-ios-runtime-dmg
      uses: actions/cache/restore@v4
      with:
        path: ~/ios-runtime-cache
        key: ${{ runner.os }}-ios-runtime-dmg-${{ hashFiles('Package.swift', 'Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-ios-runtime-dmg-

    - name: ğŸ“‹ List available simulators (debug)
      run: xcrun simctl list devices

    - name: ğŸ“± Download iOS Runtime DMG
      if: steps.cache-ios-runtime-dmg.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/ios-runtime-cache
        xcodebuild -downloadPlatform iOS -exportPath ~/ios-runtime-cache -buildVersion 22G86

    - name: ğŸ“¦ Save iOS Runtime DMG Cache
      if: steps.cache-ios-runtime-dmg.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: ~/ios-runtime-cache
        key: ${{ runner.os }}-ios-runtime-dmg-${{ hashFiles('Package.swift', 'Package.resolved') }}

    - name: ğŸ“± Install iOS Runtime from DMG
      if: steps.cache-ios-runtime-dmg.outputs.cache-hit != 'true'
      run: |
        # DMGãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
        DMG_FILE=$(find ~/ios-runtime-cache -name "*.dmg" | head -1)
        if [ -z "$DMG_FILE" ]; then
          echo "âŒ DMG file not found in cache"
          exit 1
        fi
        echo "ğŸ“± Found DMG: $DMG_FILE"
        
        # xcodebuild -importPlatformã§DMGã‚’ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        echo "âš™ï¸ Installing iOS Runtime from DMG..."
        xcodebuild -importPlatform "$DMG_FILE"
        
    - name: âœ… Run Tests
      run: |
        xcodebuild -scheme AnimatedImage test -destination "platform=iOS Simulator,name=iPhone 16,OS=latest"